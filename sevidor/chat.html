<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
</head>
<body>
    <h1>Chat</h1>
    <div id="mensajes" style="border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px;"></div>
    <input type="text" id="mensaje" placeholder="Escribe un mensaje" style="width:80%">
    <button onclick="enviar()">Enviar</button>

    <script>
        const usuario = localStorage.getItem('usuario');
        if (!usuario) window.location.href = '/inicio';

        function cargarMensajes() {
            fetch('/mensajes').then(r => r.json()).then(mensajes => {
                const div = document.getElementById('mensajes');
                div.innerHTML = '';
                mensajes.forEach(m => {
                    div.innerHTML += `<div><b>${m.usuario}:</b> ${m.mensaje}</div>`;
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        function enviar() {
            const mensaje = document.getElementById('mensaje').value;
            if (mensaje) {
                fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({usuario: usuario, mensaje: mensaje})
                }).then(() => {
                    document.getElementById('mensaje').value = '';
                    cargarMensajes();
                });
            }
        }

        setInterval(cargarMensajes, 1000);
        cargarMensajes();
    </script>
</body>
</html>